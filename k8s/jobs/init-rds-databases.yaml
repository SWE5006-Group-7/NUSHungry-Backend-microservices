---
# ================================================================
# RDS æ•°æ®åº“åˆå§‹åŒ– Kubernetes Job
# ================================================================
# ç”¨é€”: åœ¨ EKS é›†ç¾¤ä¸­åˆå§‹åŒ– RDS PostgreSQL æ•°æ®åº“
# æ‰§è¡Œ: kubectl apply -f k8s/jobs/init-rds-databases.yaml
# æŸ¥çœ‹: kubectl logs -f job/init-rds-databases -n nushungry-dev
# ================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: init-rds-databases-script
  namespace: nushungry-dev
data:
  init-databases.sql: |
    -- ================================================================
    -- NUSHungry å¾®æœåŠ¡æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
    -- ================================================================

    -- ç”¨æˆ·æœåŠ¡æ•°æ®åº“
    SELECT 'CREATE DATABASE nushungry_users'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'nushungry_users')\gexec

    -- é£Ÿå ‚æœåŠ¡æ•°æ®åº“
    SELECT 'CREATE DATABASE cafeteria_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'cafeteria_db')\gexec

    -- åª’ä½“æœåŠ¡æ•°æ®åº“
    SELECT 'CREATE DATABASE media_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'media_db')\gexec

    -- åå¥½æœåŠ¡æ•°æ®åº“
    SELECT 'CREATE DATABASE preference_db'
    WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'preference_db')\gexec

    -- ================================================================
    -- æˆäºˆæ•°æ®åº“æƒé™
    -- ================================================================

    GRANT ALL PRIVILEGES ON DATABASE nushungry_users TO postgres;
    GRANT ALL PRIVILEGES ON DATABASE cafeteria_db TO postgres;
    GRANT ALL PRIVILEGES ON DATABASE media_db TO postgres;
    GRANT ALL PRIVILEGES ON DATABASE preference_db TO postgres;

    -- ================================================================
    -- éªŒè¯æ•°æ®åº“åˆ›å»º
    -- ================================================================

    SELECT datname, pg_size_pretty(pg_database_size(datname)) as size
    FROM pg_database
    WHERE datname IN ('nushungry_users', 'cafeteria_db', 'media_db', 'preference_db')
    ORDER BY datname;

---
apiVersion: batch/v1
kind: Job
metadata:
  name: init-rds-databases
  namespace: nushungry-dev
  labels:
    app: init-rds-databases
    component: database
spec:
  # Job é…ç½®
  backoffLimit: 3
  ttlSecondsAfterFinished: 600  # 10 åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†

  template:
    metadata:
      labels:
        app: init-rds-databases
    spec:
      restartPolicy: OnFailure

      containers:
      - name: postgres-client
        image: postgres:15-alpine

        env:
        # ä» ConfigMap è¯»å–æ•°æ®åº“é…ç½®
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: DB_HOST

        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: DB_PORT

        - name: DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: DB_USERNAME

        # ä» Secret è¯»å–å¯†ç 
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: DB_PASSWORD

        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "================================================"
          echo "å¼€å§‹åˆå§‹åŒ– RDS PostgreSQL æ•°æ®åº“"
          echo "================================================"
          echo "æ•°æ®åº“ç«¯ç‚¹: ${DB_HOST}:${DB_PORT}"
          echo "ç”¨æˆ·å: ${DB_USERNAME}"
          echo ""

          # æµ‹è¯•è¿æ¥
          echo "ğŸ“¡ æµ‹è¯•æ•°æ®åº“è¿æ¥..."
          psql -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USERNAME} -d postgres -c "SELECT version();" || {
            echo "âŒ æ— æ³•è¿æ¥åˆ°æ•°æ®åº“,è¯·æ£€æŸ¥ç½‘ç»œå’Œå®‰å…¨ç»„é…ç½®"
            exit 1
          }

          echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ!"
          echo ""

          # æ‰§è¡Œåˆå§‹åŒ– SQL
          echo "ğŸ“¦ å¼€å§‹åˆ›å»ºå¾®æœåŠ¡æ•°æ®åº“..."
          psql -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USERNAME} -d postgres -f /scripts/init-databases.sql --echo-errors

          echo ""
          echo "================================================"
          echo "âœ… æ‰€æœ‰å¾®æœåŠ¡æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ!"
          echo "================================================"
          echo "å·²åˆ›å»ºçš„æ•°æ®åº“:"
          echo "  ğŸ“¦ nushungry_users   - User Service"
          echo "  ğŸ“¦ cafeteria_db      - Cafeteria Service"
          echo "  ğŸ“¦ media_db          - Media Service"
          echo "  ğŸ“¦ preference_db     - Preference Service"
          echo "================================================"

        volumeMounts:
        - name: init-script
          mountPath: /scripts
          readOnly: true

        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"

      volumes:
      - name: init-script
        configMap:
          name: init-rds-databases-script
