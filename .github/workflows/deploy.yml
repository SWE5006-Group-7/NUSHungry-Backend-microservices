# ============================================================================
# Kubernetes ÈÉ®ÁΩ≤Â∑•‰ΩúÊµÅ (ÈÄöÁî®Â§öÁéØÂ¢É)
# ============================================================================
# Áî®ÈÄî: Â∞Ü Docker ÈïúÂÉèÈÉ®ÁΩ≤Âà∞ AWS EKS
# ÊîØÊåÅ: ÂºÄÂèëÁéØÂ¢É„ÄÅÊµãËØïÁéØÂ¢É„ÄÅÁîü‰∫ßÁéØÂ¢É
# Ëß¶Âèë: ÊâãÂä®Ëß¶Âèë„ÄÅÈïúÂÉèÊé®ÈÄÅÊàêÂäüÂêéËá™Âä®Ëß¶Âèë„ÄÅÊàñ repository_dispatch
# ============================================================================

name: Deploy to Kubernetes

on:
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      services:
        description: 'Services to deploy (comma-separated, or "all")'
        required: true
        default: 'all'
        type: string
      tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
        type: string
      skip_health_check:
        description: 'Skip health check after deployment'
        required: false
        default: false
        type: boolean

  # Áî± build-and-push workflow Ëß¶Âèë
  repository_dispatch:
    types: [deploy]

  # workflow_run Ëß¶Âèë (ÂΩì build-and-push ÊàêÂäüÂÆåÊàêÂêé)
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches:
      - main
      - develop

env:
  AWS_REGION: ap-southeast-1
  DEPLOYMENT_TIMEOUT: 600s

jobs:
  # =========================================================================
  # Job 1: Á°ÆÂÆöÈÉ®ÁΩ≤ÈÖçÁΩÆ
  # =========================================================================
  determine-config:
    name: Determine Deployment Config
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      cluster_name: ${{ steps.config.outputs.cluster_name }}
      namespace: ${{ steps.config.outputs.namespace }}
      services: ${{ steps.config.outputs.services }}
      tag: ${{ steps.config.outputs.tag }}

    steps:
      - name: Determine environment and config
        id: config
        run: |
          # Á°ÆÂÆöÁéØÂ¢É
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ENV="${{ github.event.client_payload.environment || 'dev' }}"
          else
            # workflow_run Ëß¶ÂèëÊó∂Ê†πÊçÆÂàÜÊîØÁ°ÆÂÆöÁéØÂ¢É
            if [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
              ENV="dev"
            else
              ENV="dev"
            fi
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Ê†πÊçÆÁéØÂ¢ÉËÆæÁΩÆÈõÜÁæ§ÂêçÁß∞ÂíåÂëΩÂêçÁ©∫Èó¥
          case $ENV in
            prod)
              CLUSTER="nushungry-prod-eks"
              NAMESPACE="nushungry-prod"
              ;;
            staging)
              CLUSTER="nushungry-staging-eks"
              NAMESPACE="nushungry-staging"
              ;;
            *)
              CLUSTER="nushungry-dev-eks"
              NAMESPACE="nushungry-dev"
              ;;
          esac

          echo "cluster_name=$CLUSTER" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

          echo "Environment: $ENV"
          echo "Cluster: $CLUSTER"
          echo "Namespace: $NAMESPACE"

      - name: Determine services to deploy
        id: services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" == "all" ]; then
              SERVICES='["user-service","cafeteria-service","review-service","media-service","preference-service"]'
            else
              SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -R -s -c 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$";""))')
            fi
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            SERVICES='${{ github.event.client_payload.services }}'
          else
            # workflow_run Ëß¶ÂèëÊó∂ÈÉ®ÁΩ≤ÊâÄÊúâÊúçÂä°
            SERVICES='["user-service","cafeteria-service","review-service","media-service","preference-service"]'
          fi
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Services to deploy: $SERVICES"

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.tag }}"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Deploying image tag: $TAG"

  # =========================================================================
  # Job 2: È™åËØÅÈÉ®ÁΩ≤ÂâçÊèêÊù°‰ª∂
  # =========================================================================
  validate-prerequisites:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    needs: determine-config
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify K8s manifests exist
        run: |
          SERVICES='${{ needs.determine-config.outputs.services }}'
          for service in $(echo $SERVICES | jq -r '.[]'); do
            manifest="k8s/services/${service}/deployment.yaml"
            if [ ! -f "$manifest" ]; then
              echo "‚ùå Missing manifest: $manifest"
              exit 1
            fi
            echo "‚úÖ Found manifest: $manifest"
          done

  # =========================================================================
  # Job 3: ÈÉ®ÁΩ≤Âà∞ EKS
  # =========================================================================
  deploy-to-eks:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs:
      - determine-config
      - validate-prerequisites
    environment: ${{ needs.determine-config.outputs.environment }}

    strategy:
      fail-fast: false
      max-parallel: 2  # ÈÄêÊ≠•ÈÉ®ÁΩ≤,ÈÅøÂÖçÂêåÊó∂ÊªöÂä®Êõ¥Êñ∞ÊâÄÊúâÊúçÂä°
      matrix:
        service: ${{ fromJson(needs.determine-config.outputs.services) }}

    steps:
      # =====================================================================
      # 1. Ê£ÄÂá∫‰ª£Á†Å
      # =====================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # =====================================================================
      # 2. ÈÖçÁΩÆ AWS Âá≠ËØÅ
      # =====================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # =====================================================================
      # 3. ÈÖçÁΩÆ kubectl
      # =====================================================================
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ needs.determine-config.outputs.cluster_name }} \
            --region ${{ env.AWS_REGION }}

          # È™åËØÅÈõÜÁæ§ËøûÊé•
          kubectl cluster-info
          kubectl get nodes

      # =====================================================================
      # 4. ÂàõÂª∫/Êõ¥Êñ∞ Namespace
      # =====================================================================
      - name: Ensure namespace exists
        run: |
          kubectl get namespace ${{ needs.determine-config.outputs.namespace }} || \
          kubectl create namespace ${{ needs.determine-config.outputs.namespace }}

      # =====================================================================
      # 5. ÂàõÂª∫/Êõ¥Êñ∞ Secrets (È¶ñÊ¨°ÈÉ®ÁΩ≤)
      # =====================================================================
      - name: Create/Update Kubernetes Secrets
        run: |
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          # PostgreSQL Secret
          kubectl create secret generic postgres-secret \
            --from-literal=username=postgres \
            --from-literal=password='${{ secrets.DB_PASSWORD }}' \
            --from-literal=url='${{ secrets.POSTGRES_URL }}' \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          # MongoDB Secret
          kubectl create secret generic mongodb-secret \
            --from-literal=username=admin \
            --from-literal=password='${{ secrets.MONGODB_PASSWORD }}' \
            --from-literal=uri='${{ secrets.MONGODB_URI }}' \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          # Redis Secret
          kubectl create secret generic redis-secret \
            --from-literal=host='${{ secrets.REDIS_HOST }}' \
            --from-literal=port=6379 \
            --from-literal=password='${{ secrets.REDIS_PASSWORD }}' \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          # JWT Secret
          kubectl create secret generic jwt-secret \
            --from-literal=secret='${{ secrets.JWT_SECRET }}' \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          # Amazon MQ Secret
          kubectl create secret generic amazonmq-secret \
            --from-literal=host='${{ secrets.RABBITMQ_HOST }}' \
            --from-literal=port=5671 \
            --from-literal=username=admin \
            --from-literal=password='${{ secrets.RABBITMQ_PASSWORD }}' \
            --from-literal=vhost="/" \
            --from-literal=ssl="true" \
            --namespace $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ All secrets created/updated"

      # =====================================================================
      # 6. Êõ¥Êñ∞ÈÉ®ÁΩ≤Ê∏ÖÂçï‰∏≠ÁöÑÈïúÂÉèÊ†áÁ≠æ
      # =====================================================================
      - name: Update image tag in deployment manifest
        run: |
          SERVICE="${{ matrix.service }}"
          TAG="${{ needs.determine-config.outputs.tag }}"
          ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          MANIFEST="k8s/services/${SERVICE}/deployment.yaml"

          echo "Updating $MANIFEST with image: ${ECR_REGISTRY}/${SERVICE}:${TAG}"

          # ‰ΩøÁî® sed Êõ¥Êñ∞ÈïúÂÉèÊ†áÁ≠æ
          sed -i "s|image: .*/${SERVICE}:.*|image: ${ECR_REGISTRY}/${SERVICE}:${TAG}|g" "$MANIFEST"

          echo "Updated manifest:"
          grep "image:" "$MANIFEST"

      # =====================================================================
      # 7. Â∫îÁî® ConfigMap (Â¶ÇÊûúÂ≠òÂú®)
      # =====================================================================
      - name: Apply ConfigMaps
        run: |
          if [ -f "k8s/base/configmap.yaml" ]; then
            kubectl apply -f k8s/base/configmap.yaml -n ${{ needs.determine-config.outputs.namespace }}
          fi
        continue-on-error: true

      # =====================================================================
      # 8. ÈÉ®ÁΩ≤ÊúçÂä°
      # =====================================================================
      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          echo "Deploying $SERVICE to $NAMESPACE..."

          # Â∫îÁî® Deployment
          kubectl apply -f k8s/services/${SERVICE}/deployment.yaml -n $NAMESPACE

          # Â∫îÁî® Service
          kubectl apply -f k8s/services/${SERVICE}/service.yaml -n $NAMESPACE

          # Â∫îÁî® HPA (Â¶ÇÊûúÂ≠òÂú®)
          if [ -f "k8s/services/${SERVICE}/hpa.yaml" ]; then
            kubectl apply -f k8s/services/${SERVICE}/hpa.yaml -n $NAMESPACE
          fi

      # =====================================================================
      # 9. Á≠âÂæÖÊªöÂä®Êõ¥Êñ∞ÂÆåÊàê
      # =====================================================================
      - name: Wait for rollout to complete
        run: |
          SERVICE="${{ matrix.service }}"
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          echo "Waiting for $SERVICE deployment to complete..."

          kubectl rollout status deployment/${SERVICE} \
            -n $NAMESPACE \
            --timeout=${{ env.DEPLOYMENT_TIMEOUT }}

      # =====================================================================
      # 10. È™åËØÅÈÉ®ÁΩ≤
      # =====================================================================
      - name: Verify deployment
        run: |
          SERVICE="${{ matrix.service }}"
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          echo "Pod status:"
          kubectl get pods -l app=${SERVICE} -n $NAMESPACE

          echo ""
          echo "Deployment status:"
          kubectl get deployment ${SERVICE} -n $NAMESPACE

          echo ""
          echo "Recent events:"
          kubectl get events -n $NAMESPACE \
            --field-selector involvedObject.name=${SERVICE} \
            --sort-by='.lastTimestamp' | tail -10

      # =====================================================================
      # 11. ÂÅ•Â∫∑Ê£ÄÊü•
      # =====================================================================
      - name: Health check
        if: github.event.inputs.skip_health_check != 'true'
        run: |
          SERVICE="${{ matrix.service }}"
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          echo "Performing health check for $SERVICE..."

          # Ëé∑Âèñ Pod ÂêçÁß∞
          POD_NAME=$(kubectl get pods -l app=${SERVICE} -n $NAMESPACE \
            -o jsonpath='{.items[0].metadata.name}')

          if [ -z "$POD_NAME" ]; then
            echo "‚ùå No pod found for $SERVICE"
            exit 1
          fi

          # Á≠âÂæÖ Pod ËøõÂÖ• Running Áä∂ÊÄÅ
          kubectl wait --for=condition=ready pod/${POD_NAME} \
            -n $NAMESPACE \
            --timeout=300s

          # Á´ØÂè£ËΩ¨ÂèëÂπ∂ÊµãËØïÂÅ•Â∫∑Á´ØÁÇπ
          kubectl port-forward pod/${POD_NAME} 8080:8080 -n $NAMESPACE &
          PF_PID=$!

          sleep 5

          # ÊµãËØï actuator health Á´ØÁÇπ
          if curl -f http://localhost:8080/actuator/health; then
            echo "‚úÖ Health check passed for $SERVICE"
          else
            echo "‚ùå Health check failed for $SERVICE"
            kill $PF_PID 2>/dev/null || true
            exit 1
          fi

          kill $PF_PID 2>/dev/null || true
        continue-on-error: true

      # =====================================================================
      # 12. ËæìÂá∫ÈÉ®ÁΩ≤‰ø°ÊÅØ
      # =====================================================================
      - name: Output deployment info
        run: |
          echo "## üöÄ Deployment Complete: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`${{ needs.determine-config.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag**: \`${{ needs.determine-config.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ needs.determine-config.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -l app=${{ matrix.service }} -n ${{ needs.determine-config.outputs.namespace }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Job 4: ÈÉ®ÁΩ≤ Ingress (ÊâÄÊúâÊúçÂä°ÈÉ®ÁΩ≤ÂÆåÊàêÂêé)
  # =========================================================================
  deploy-ingress:
    name: Deploy Ingress
    runs-on: ubuntu-latest
    needs:
      - determine-config
      - deploy-to-eks
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ needs.determine-config.outputs.cluster_name }} \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Ingress
        run: |
          NAMESPACE="${{ needs.determine-config.outputs.namespace }}"

          if [ -f "k8s/ingress/ingress.yaml" ]; then
            kubectl apply -f k8s/ingress/ingress.yaml -n $NAMESPACE
            echo "‚úÖ Ingress deployed"

            # Á≠âÂæÖ ALB ÂàõÂª∫
            echo "Waiting for Load Balancer to be ready..."
            sleep 30

            # Ëé∑Âèñ ALB Âú∞ÂùÄ
            ALB_URL=$(kubectl get ingress -n $NAMESPACE \
              -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')

            if [ -n "$ALB_URL" ]; then
              echo "üåê Application available at: http://$ALB_URL"
              echo "ALB_URL=$ALB_URL" >> $GITHUB_ENV
            fi
          else
            echo "‚ö†Ô∏è Ingress manifest not found, skipping..."
          fi
        continue-on-error: true

  # =========================================================================
  # Job 5: ÈÉ®ÁΩ≤ÊÄªÁªì
  # =========================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - determine-config
      - deploy-to-eks
      - deploy-ingress
    if: always()

    steps:
      - name: Generate deployment summary
        run: |
          echo "# üéâ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`${{ needs.determine-config.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: \`${{ needs.determine-config.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`${{ needs.determine-config.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`${{ needs.determine-config.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed At**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.determine-config.outputs.services }}' | jq . >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy to EKS**: ${{ needs.deploy-to-eks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Ingress**: ${{ needs.deploy-ingress.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Verification Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Configure kubectl" >> $GITHUB_STEP_SUMMARY
          echo "aws eks update-kubeconfig --name ${{ needs.determine-config.outputs.cluster_name }} --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check pod status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n ${{ needs.determine-config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check services" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get svc -n ${{ needs.determine-config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check ingress" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get ingress -n ${{ needs.determine-config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/<service-name> -n ${{ needs.determine-config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check overall deployment status
        run: |
          if [ "${{ needs.deploy-to-eks.result }}" != "success" ]; then
            echo "‚ùå Deployment failed!"
            exit 1
          fi
          echo "‚úÖ All services deployed successfully to ${{ needs.determine-config.outputs.environment }} environment!"
